from PyQt5.QtWidgets import QMainWindow, QFileDialog, QPushButton, QMenu, QDialog
from PyQt5.QtCore import Qt, QTimer
# Core import
from core.exporter import save_to_csv, save_to_excel, export_data_to_json
from core import cookie_manager
from core.storage import load_settings, save_settings
from core.session_service import SessionController
# Date import
from datetime import datetime
# pyright: reportMissingImports=false
import sip

# –ü–æ–ª–Ω—ã–π –¥–æ—Å—Ç—É–ø –∫ table_utils —á–µ—Ä–µ–∑ namespace
from ui import table_utils
# –î–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω–æ ‚Äî –∏–º–ø–æ—Ä—Ç —á–∞—Å—Ç–æ –∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö —Ñ—É–Ω–∫—Ü–∏–π –Ω–∞–ø—Ä—è–º—É—é
from ui.table_utils import (
    update_lcd_counters,
    colorize_row_by_status,
    add_task_row as base_add_task_row,
    create_save_button
)
from ui.table_controller import TableController
from ui import editor_handlers
from ui.scraper_ui import Ui_MainWindow
# Utils import
from utils.context_menu import show_context_menu
# Dialog import
from dialogs.params_dialog import show_params_dialog
from dialogs.session_dialog import SessionHistoryDialog
from dialogs.search_dialog import SearchDialog
from dialogs.timer_dialog import TimerDialog
from dialogs.timer_dialog import TimerDialog
from dialogs.analytics_dialog import AnalyticsDialog
from dialogs.calendar_dialog import CalendarDialog


# USER SETTINGS FILE
USER_SETTINGS_FILE = "user_settings.json"


class ScraperApp(QMainWindow):
    def __init__(self):
        super().__init__()
        self.ui = Ui_MainWindow()
        self.ui.setupUi(self)
        
        # Calendar Widget
        self.ui.action_open_calendar.triggered.connect(self.open_calendar_dialog)

        # Column settings
        self.load_column_widths()

        # üì¶ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –í–°–ï–• —Ä–∞–±–æ—á–∏—Ö —Å—Ç—Ä—É–∫—Ç—É—Ä –î–û –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –∑–∞–¥–∞—á
        self.task_params = {}     # row -> request params
        self.task_intervals = {}  # row -> seconds
        self.task_timers = {}     # row -> QTimer
        self.task_results = {}    # row -> result list
        self.workers = []         # list of TaskWorker

        # ‚úÖ –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è TaskManager
        from core.task_manager import TaskManager
        self.task_manager = TaskManager(
            table=self.ui.tasks_table,
            task_results=self.task_results,
            task_params=self.task_params,
            update_lcd_callback=self.update_lcd,
            update_tooltips_callback=self.update_tooltips,
            lock_row_callback=self.lock_row
        )
        
        # Table controller
        self.table_controller = TableController(
            table_widget=self.ui.tasks_table,
            task_params=self.task_params
        )
        
        # SessionControler
        self.session_controller = SessionController(
            table_controller=self.table_controller,
            add_task_callback=self.add_task_row,  # –º–µ—Ç–æ–¥, –∫–æ—Ç–æ—Ä—ã–π –¥–æ–±–∞–≤–ª—è–µ—Ç —Å—Ç—Ä–æ–∫—É –≤ —Ç–∞–±–ª–∏—Ü—É
            task_params=self.task_params,
            task_results=self.task_results,
            task_intervals=self.task_intervals
        )
        
        # Search connection
        self.ui.action_search_tasks.triggered.connect(self.open_search_dialog)

        # Filters for search
        self.active_filters = []

        # Sessions
        self.ui.action_manage_sessions.triggered.connect(self.open_session_history)
        self.ui.action_save_session.triggered.connect(self.save_current_session)

        # üìå –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
        self.ui.tasks_table.setContextMenuPolicy(3)  # Qt.CustomContextMenu
        self.ui.tasks_table.customContextMenuRequested.connect(self.show_table_context_menu)

        # üìå –î–≤–æ–π–Ω–æ–π –∫–ª–∏–∫ ‚Äî —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ
        self.ui.tasks_table.cellDoubleClicked.connect(self.edit_cell_handler)

        # üìå Toolbar –¥–µ–π—Å—Ç–≤–∏—è
        self.ui.action_add_task_2.triggered.connect(self.add_template_task)
        self.ui.action_del_task.triggered.connect(self.delete_task)
        self.ui.action_run_task.triggered.connect(self.run_task_stub)
        self.ui.action_run_selected_bulk.triggered.connect(self.run_selected_tasks_bulk)
        self.ui.action_delete_selected_bulk.triggered.connect(self.delete_selected_tasks_bulk)
        self.ui.action_save_selected_bulk.triggered.connect(self.save_selected_results_bulk)
        self.ui.action_run_analytics.triggered.connect(self.run_analytics_dialog)

        # üìå –î–æ–±–∞–≤–∏–º –æ–¥–Ω—É –∑–∞–¥–∞—á—É –¥–ª—è –ø—Ä–∏–º–µ—Ä–∞ (–ø–æ—Å–ª–µ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏ task_params!)
        self.add_template_task()

        # –ü—Ä–∏–≤—è–∑—ã–≤–∞–µ–º –∫ –¥–µ–π—Å—Ç–≤–∏—é –∫–Ω–æ–ø–∫—É –∑–∞–ø—É—Å–∫–∞
        self.ui.action_run_task.triggered.connect(self.run_selected_task)

        # LCD Timer counter
        self.lcd_counters = {
            "total": self.ui.lcd_total,
            "running": self.ui.lcd_running,
            "success": self.ui.lcd_success,
            "error": self.ui.lcd_error,
            "stopped": self.ui.lcd_stopped
        }


    # ============================
    # üîπ –î–µ–π—Å—Ç–≤–∏—è
    # ============================

    def add_task_row(self, url, selector, method, status):
        row_position = self.ui.tasks_table.rowCount()

        # üîπ –î–æ–±–∞–≤–ª—è–µ–º —Å—Ç—Ä–æ–∫—É —á–µ—Ä–µ–∑ table_logic
        base_add_task_row(self.ui.tasks_table, url, selector, method, status)

        # üîπ –ö–Ω–æ–ø–∫–∞ "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å"
        save_button = create_save_button()
        save_button.clicked.connect(lambda _, r=row_position: self.save_task_result(r))
        self.ui.tasks_table.setCellWidget(row_position, 6, save_button)
        
        # COOKIE BUTTON IN TABLE
        cookie_button = QPushButton("üç™ –ö—É–∫–∏")
        cookie_button.clicked.connect(lambda _, r=row_position: self.load_cookie_file(r))
        self.ui.tasks_table.setCellWidget(row_position, 7, cookie_button)
        
        # üîπ –í–æ—Ç —Å—é–¥–∞ –î–û–ë–ê–í–¨ ‚¨áÔ∏è –ø—É—Å—Ç—É—é —è—á–µ–π–∫—É –¥–ª—è Last Run
        self.ui.tasks_table.setItem(row_position, 10, self.create_item("")) 
        
        # Update Toolbar Tips
        self.update_tooltips(row_position)


    def add_template_task(self):
        self.add_task_row("https://example.com", "a", "CSS", "–û–∂–∏–¥–∞–µ—Ç")
        self.update_lcd()
    
    def delete_task(self):
        table_utils.delete_selected_row(self.ui.tasks_table)
        self.update_lcd()

    def run_task_stub(self):
        row = self.ui.tasks_table.currentRow()
        if row >= 0:
            self.table_controller.update_row_status(row, "‚è≥ –í—ã–ø–æ–ª–Ω—è–µ—Ç—Å—è")
        self.update_lcd()

    # ============================
    # üîπ –ö–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–µ –º–µ–Ω—é
    # ============================

    def show_table_context_menu(self, position):
        index = self.ui.tasks_table.indexAt(position)
        row = index.row()
        column = index.column()

        if row < 0:
            return

        # üí° –ï—Å–ª–∏ –∫–ª–∏–∫–Ω—É–ª–∏ –ø–æ –∫–æ–ª–æ–Ω–∫–µ Timer
        if column == 9:
            menu = QMenu()

            menu.addAction("üîÅ –ü–µ—Ä–µ—É—Å—Ç–∞–Ω–æ–≤–∏—Ç—å —Ç–∞–π–º–µ—Ä", lambda: self.edit_timer_for_row(row))
            menu.addAction("‚èπ –û—Ç–∫–ª—é—á–∏—Ç—å —Ç–∞–π–º–µ—Ä", lambda: self.configure_task_timer(row, 0))

            menu.exec_(self.ui.tasks_table.viewport().mapToGlobal(position))
            return

        # üîÅ –ò–Ω–∞—á–µ ‚Äî –æ–±—ã—á–Ω–æ–µ –º–µ–Ω—é
        show_context_menu(
            self,
            self.ui.tasks_table,
            position,
            lambda: update_lcd_counters(self.ui.tasks_table, self.lcd_counters),
            self.run_selected_task,
            self.add_task_row
        )

    # ============================
    # üîπ –†–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–µ–∫
    # ============================

    def edit_cell_handler(self, row, column):
        if column == 9:  # –¢–∞–π–º–µ—Ä
            self.configure_timer_dialog(row)
            return

        if column == 8:  # Params
            self.edit_params_modal(row)

        editor_handlers.edit_cell(
            parent=self,
            table=self.ui.tasks_table,
            row=row,
            column=column
        )
        
    def edit_params_modal(self, row):
        old_params = self.task_params.get(row, {})
        result = show_params_dialog(self, old_params)
        
        if result:
            self.task_params[row] = result
            self.ui.tasks_table.setItem(row, 8, self.create_item("‚úÖ –ù–∞—Å—Ç—Ä–æ–µ–Ω–æ"))
            self.statusBar().showMessage(f"üõ† –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –æ–±–Ω–æ–≤–ª–µ–Ω—ã –¥–ª—è —Å—Ç—Ä–æ–∫–∏ #{row + 1}")
            self.update_tooltips(row)  # ‚¨ÖÔ∏è –û–±–Ω–æ–≤–ª—è–µ–º –ø–æ–¥—Å–∫–∞–∑–∫—É
        else:
            self.statusBar().showMessage("‚ùå –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –Ω–µ –±—ã–ª–∏ –∏–∑–º–µ–Ω–µ–Ω—ã")


    # ============================
    # üîπ LCD –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ
    # ============================

    def update_lcd(self):
        table_utils.update_lcd_counters(
            self.ui.tasks_table,
            {
                'total': self.ui.lcd_total,
                'running': self.ui.lcd_running,
                'success': self.ui.lcd_success,
                'error': self.ui.lcd_error,
                'stopped': self.ui.lcd_stopped,
            }
        )
        
    def run_selected_task(self):
        row = self.ui.tasks_table.currentRow()
        if row < 0:
            self.statusBar().showMessage("‚ö† –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á—É –¥–ª—è –∑–∞–ø—É—Å–∫–∞")
            return
        self.task_manager.run_task(row)

    def on_task_finished(self, row_index, status_text, message, results, cookies):
        
        self.ui.tasks_table.setItem(row_index, 4, self.create_item(status_text))
        colorize_row_by_status(self.ui.tasks_table, row_index)
        self.lock_row(row_index, False)  # üîì –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞—Ç—å —Å—Ç—Ä–æ–∫—É
        task = self.table_controller.get_task_data(row_index)
        url = task["url"]
        cookie_manager.save_cookies(url, cookies)
        self.statusBar().showMessage(f"–ó–∞–¥–∞—á–∞ #{row_index + 1} –∑–∞–≤–µ—Ä—à–µ–Ω–∞: {message}")
        self.update_lcd()

        task = self.table_controller.get_task_data(row_index)
        url = task["url"]

        self.task_results[row_index] = {
            "url": url,
            "status": status_text,
            "message": message,
            "results": results,
            "last_run": datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        }
        
        self.ui.tasks_table.resizeColumnsToContents()

    def create_item(self, text):
        from PyQt5.QtWidgets import QTableWidgetItem
        return QTableWidgetItem(text)


    def save_task_result(self, row_index):
        task = self.task_results.get(row_index)
        if not task or not task.get("results"):
            self.statusBar().showMessage("‚ö† –ù–µ—Ç –¥–∞–Ω–Ω—ã—Ö –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è")
            return

        url = task["url"]
        results = task["results"]

        file_path, _ = QFileDialog.getSaveFileName(self, "–°–æ—Ö—Ä–∞–Ω–∏—Ç—å —Ä–µ–∑—É–ª—å—Ç–∞—Ç", "", 
                                                "JSON (*.json);;CSV (*.csv);;Excel (*.xlsx)")

        if not file_path:
            return

        if file_path.endswith(".csv"):
            save_to_csv({url: results}, file_path)
        elif file_path.endswith(".xlsx"):
            save_to_excel({url: results}, file_path)
        else:
            data = export_data_to_json({url: results}, format_type="default")
            with open(file_path, "w", encoding="utf-8") as f:
                import json
                json.dump(data, f, indent=4, ensure_ascii=False)

        self.statusBar().showMessage(f"‚úÖ –°–æ—Ö—Ä–∞–Ω–µ–Ω–æ: {file_path}")
        
        
    def lock_row(self, row_index, lock=True):
        """–ë–ª–æ–∫–∏—Ä—É–µ—Ç –∏–ª–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä—É–µ—Ç —Ä–µ–¥–∞–∫—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ —è—á–µ–µ–∫ —Å—Ç—Ä–æ–∫–∏."""
        for col in range(1, 4):  # URL, Selector, Method ‚Äî –∫–æ–ª–æ–Ω–∫–∏ 1, 2, 3
            item = self.ui.tasks_table.item(row_index, col)
            if item:
                flags = item.flags()
                if lock:
                    item.setFlags(flags & ~Qt.ItemIsEditable)
                else:
                    item.setFlags(flags | Qt.ItemIsEditable)
                    
    
    def load_cookie_file(self, row_index):
        task = self.table_controller.get_task_data(row_index)
        url = task["url"]
        if cookie_manager.cookie_exists(url):
            path = cookie_manager.get_cookie_path(url)
            self.statusBar().showMessage(f"üç™ –ö—É–∫–∏ –∑–∞–≥—Ä—É–∂–µ–Ω—ã: {path}")
        else:
            self.statusBar().showMessage(f"‚ö† –ö—É–∫–∏ –¥–ª—è –∑–∞–¥–∞—á–∏ #{row_index + 1} –Ω–µ –Ω–∞–π–¥–µ–Ω—ã")
         
         
    # SESSION SECTION
    # SESSION SECTION   
            
    def open_session_history(self):
        def load_callback(session_data):
            self.restore_session(session_data)

        dialog = SessionHistoryDialog(self, load_callback=load_callback)
        dialog.exec_()
        
    # RESTORE SESSION 
    # RESTORE SESSION
        
    def restore_session(self, session_data):
        self.session_controller.restore_session(session_data)
        self.statusBar().showMessage("–°–µ—Å—Å–∏—è –≤–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ —É—Å–ø–µ—à–Ω–æ")
   
    # SAVE SESSION
    # SAVE SESSION
        
    def save_current_session(self):
        from PyQt5.QtWidgets import QInputDialog
        name, ok = QInputDialog.getText(self, "–°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ —Å–µ—Å—Å–∏–∏", "–í–≤–µ–¥–∏—Ç–µ –∏–º—è —Å–µ—Å—Å–∏–∏:")
        if ok and name:
            path = self.session_controller.save_session(name)
            self.statusBar().showMessage(f"–°–µ—Å—Å–∏—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∞: {path}")
            
    # SEARCH BLOCK SECTION
    
    def open_search_dialog(self):
        def handle_filters(filters):
            self.active_filters = filters  # –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–µ–∫—É—â–∏–µ
            self.table_controller.apply_filters(filters)

        dialog = SearchDialog(self, search_callback=handle_filters, initial_filters=self.active_filters)
        dialog.exec_()

        
        
    # SEARCH TABLE FILTER 

    def apply_table_filters(self, filters):
        """
        –ü–æ–¥–¥–µ—Ä–∂–∫–∞:
        - –ò–õ–ò –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–ª—è (URL, Selector, Status)
        - –ò –º–µ–∂–¥—É —Ä–∞–∑–Ω—ã–º–∏ –ø–æ–ª—è–º–∏
        - –¢–æ—á–Ω–∞—è –ø—Ä–æ–≤–µ—Ä–∫–∞ —Å–µ–ª–µ–∫—Ç–æ—Ä–æ–≤ (—Ä–∞–∑–¥–µ–ª—ë–Ω–Ω—ã–µ –∑–∞–ø—è—Ç—ã–º–∏)
        """
        from collections import defaultdict

        grouped = defaultdict(list)
        for field, value in filters:
            grouped[field].append(value.lower())

        field_to_column = {"URL": 1, "Selector": 2, "Status": 4, "Last Run": 10}

        for row in range(self.ui.tasks_table.rowCount()):
            match = True

            for field, values in grouped.items():
                col_index = field_to_column.get(field)
                if col_index is None:
                    continue

                item = self.ui.tasks_table.item(row, col_index)
                cell_text = item.text().lower() if item else ""

                if field == "Selector":
                    selectors = [s.strip() for s in cell_text.split(",")]
                    if not any(v in selectors for v in values):
                        match = False
                        break
                else:
                    if not any(v in cell_text for v in values):
                        match = False
                        break

            self.ui.tasks_table.setRowHidden(row, not match)
            
            
    # TIMER SETTINGS BLOCK
    
    def configure_timer_dialog(self, row):
        current = self.task_intervals.get(row, 0)
        dialog = TimerDialog(self, current_seconds=current)
        if dialog.exec_():
            seconds = dialog.result_seconds or 0
            self.task_intervals[row] = seconds
            label = "–û—Ç–∫–ª—é—á–µ–Ω–æ" if seconds == 0 else f"‚è± {seconds // 60} –º–∏–Ω"
            self.ui.tasks_table.setItem(row, 9, self.create_item(label))
            self.configure_task_timer(row, seconds)
            
    # TIMER CONFIGURE

    def configure_task_timer(self, row, seconds):
        # ‚õî –ë–µ–∑–æ–ø–∞—Å–Ω–æ –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º —Å—Ç–∞—Ä—ã–π —Ç–∞–π–º–µ—Ä
        old_timer = self.task_timers.get(row)
        if old_timer and not sip.isdeleted(old_timer):
            old_timer.stop()
            old_timer.deleteLater()

        # –û–±–Ω–æ–≤–ª—è–µ–º –∏–Ω—Ç–µ—Ä–≤–∞–ª
        self.task_intervals[row] = seconds

        # –û–±–Ω–æ–≤–ª—è–µ–º –æ—Ç–æ–±—Ä–∞–∂–µ–Ω–∏–µ –≤ –∫–æ–ª–æ–Ω–∫–µ
        label = "–û—Ç–∫–ª—é—á–µ–Ω–æ" if seconds == 0 else f"‚è± {seconds // 60} –º–∏–Ω"
        self.ui.tasks_table.setItem(row, 9, self.create_item(label))

        # –ï—Å–ª–∏ –∑–∞–¥–∞–Ω –Ω–æ–≤—ã–π –∏–Ω—Ç–µ—Ä–≤–∞–ª ‚Äî —Å–æ–∑–¥–∞—ë–º —Ç–∞–π–º–µ—Ä
        if seconds > 0:
            timer = QTimer(self)
            timer.timeout.connect(lambda r=row: self.run_scheduled_task(r))
            timer.start(seconds * 1000)
            self.task_timers[row] = timer

        self.update_tooltips(row)

    
    # START TIMER
    
    def run_scheduled_task(self, row):
        self.ui.tasks_table.selectRow(row)

        # üïì –£—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –≤—Ä–µ–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∑–∞–ø—É—Å–∫–∞
        timestamp = datetime.now().strftime("%Y-%m-%d %H:%M:%S")
        self.table_controller.set_last_run(row, timestamp)
        self.run_selected_task()
        
    # EDIT TIMER METHOD
    
    def edit_timer_for_row(self, row):
        current_seconds = self.task_intervals.get(row, 0)
        dialog = TimerDialog(self, current_seconds=current_seconds)

        if dialog.exec_() == QDialog.Accepted:
            seconds = dialog.result_seconds
            self.configure_task_timer(row, seconds)
            self.update_tooltips(row)

        
    # TOOLBAR TIPS EXPLANATION
    
    def update_tooltips(self, row):
        url_item = self.ui.tasks_table.item(row, 1)
        params_item = self.ui.tasks_table.item(row, 8)
        timer_item = self.ui.tasks_table.item(row, 9)

        if url_item:
            from core.cookie_manager import get_cookie_path
            url = url_item.text()
            tooltip = get_cookie_path(url)
            url_item.setToolTip(f"üç™ Cookies path: {tooltip}")

        if params_item:
            params = self.task_params.get(row, {})
            if not params:
                params_item.setToolTip("‚ùå No params set")
            else:
                desc = []
                if params.get("proxy"):
                    desc.append(f"Proxy: {params['proxy']}")
                if params.get("user_agent"):
                    desc.append(f"UA: {params['user_agent'][:40]}...")
                if params.get("timeout"):
                    desc.append(f"Timeout: {params['timeout']}s")
                if params.get("headers"):
                    desc.append(f"Headers: {len(params['headers'])} items")
                params_item.setToolTip(" | ".join(desc))

        if timer_item:
            seconds = self.task_intervals.get(row, 0)
            if seconds:
                timer_item.setToolTip(f"‚è± Task will auto-run in ~{seconds} sec")
            else:
                timer_item.setToolTip("‚èπ Timer disabled")
                
    # SELECTED ROWS WITH CTRL/SHIFT
    # SELECTED ROWS WITH CTRL/SHIFT
    
    def get_selected_rows(self):
        return list(set(index.row() for index in self.ui.tasks_table.selectedIndexes()))
    
    def run_selected_tasks_bulk(self):
        rows = self.get_selected_rows()
        for row in rows:
            self.ui.tasks_table.selectRow(row)  # –¥–ª—è —Å–æ–≤–º–µ—Å—Ç–∏–º–æ—Å—Ç–∏ —Å —Ç–µ–∫—É—â–∏–º –º–µ—Ç–æ–¥–æ–º
            self.run_selected_task()
            

    def delete_selected_tasks_bulk(self):
        rows = sorted(self.get_selected_rows(), reverse=True)
        for row in rows:
            self.ui.tasks_table.removeRow(row)
        self.update_lcd()
        
        
    def save_selected_results_bulk(self):
        rows = self.get_selected_rows()
        for row in rows:
            self.save_task_result(row)
            
    # SAVE COLUMN WIDTH
            
    def save_column_widths(self):
        settings = load_settings()
        widths = {}

        for col in range(self.ui.tasks_table.columnCount()):
            widths[str(col)] = self.ui.tasks_table.columnWidth(col)

        settings["column_widths"] = widths
        save_settings(settings)
            
    # LOAD SAVE COLUMN WIDTH

    def load_column_widths(self):
        settings = load_settings()
        widths = settings.get("column_widths", {})

        for col_str, width in widths.items():
            col = int(col_str)
            if 0 <= col < self.ui.tasks_table.columnCount():
                self.ui.tasks_table.setColumnWidth(col, width)

            
    # WHEN CLOSE APP SAVE COLUMN WIDTH
    
    def closeEvent(self, event):
        self.save_column_widths()
        event.accept()
        
    # ANALYTICS QDIALOG
    
    def run_analytics_dialog(self):
        rows = self.get_selected_rows()
        if not rows:
            self.statusBar().showMessage("‚ö† –í—ã–±–µ—Ä–∏—Ç–µ –∑–∞–¥–∞—á–∏ –¥–ª—è –∞–Ω–∞–ª–∏–∑–∞")
            return

        dialog = AnalyticsDialog(self, rows=rows, task_results=self.task_results)
        dialog.exec_()


    def open_calendar_dialog(self):
        dialog = CalendarDialog(self, self.task_results, self.restore_session)
        dialog.exec_()